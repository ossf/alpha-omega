import logging
from io import BytesIO
import zipfile
import requests
import re
from defusedxml.minidom import parse as parse_xml

from django.core.management.base import BaseCommand
from oaffe.models import PolicyEvaluationQueue, Policy
from oaffe.utils.policy import refresh_policies

logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = "Refresh CWE policies from MITRE."

    def handle(self, *args, **options):
        """Handle the 'process_evaluation_queue' command."""
        logger.debug("Processing evaluation queue")

        self.cwe_data = {}
        self.load_cwe_data('699.xml.zip')
        self.load_cwe_data('1000.xml.zip')

        for cwe_id, cwe in self.cwe_data.items():
            name = 'CWE-' + cwe_id[4:] + ': ' + cwe['name'].replace("'", '"')
            cwe_id_safe = cwe_id.replace('-', '_')
            policy_identifier = f'openssf.omega.policy.autogenerated.cwe.{cwe_id_safe}'

            policy, _new = Policy.objects.get_or_create(identifier=policy_identifier, defaults={"name": name, "help_text": cwe['description']})
            if not _new:
                policy.name = name
                policy.help_text = ("#### Description\n\n" +
                                    cwe['description'] + "\n\n" +
                                    "*This information was retrieved from the MITRE CWE website.*")
                policy.save()

    def load_cwe_data(self, filename):
        res = requests.get(f"https://cwe.mitre.org/data/xml/views/{filename}", timeout=30)
        res.raise_for_status()
        memory_stream = BytesIO(res.content)

        filename_bare = filename.replace(".zip", "")

        with (zipfile.ZipFile(memory_stream) as z,
              z.open(filename_bare) as f):
            dom = parse_xml(f)
            for weakness in dom.getElementsByTagName('Weakness'):
                cwe_id = 'cwe-' + weakness.getAttribute("ID")
                description = weakness.getElementsByTagName("Description")[0].firstChild.nodeValue
                description = description.replace("\n", " ").replace("\r", " ")
                description = re.sub(r"\s+", " ", description).strip()

                self.cwe_data[cwe_id] = {
                    'name': weakness.getAttribute("Name"),
                    'description': description
                }
